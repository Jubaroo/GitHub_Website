<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Background Removal</title>
    <link rel="stylesheet" href="styles/navbar.css" />
    <link rel="stylesheet" href="styles/sidebar.css" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
        background-color: #000;
        color: red;
        display: flex;
        flex-direction: column;
      }
      footer {
        background-color: #8b0000;
        color: #fff;
        text-align: center;
        padding: 1em;
        position: sticky;
        bottom: 0;
        z-index: 10;
      }
      .container {
        flex: 1;
        display: flex;
        position: relative;
      }
      .main-content {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .comparison-container {
        position: relative;
        display: inline-block;
        margin: 20px auto;
        overflow: hidden;
        max-width: 100%;
      }
      .comparison-container .image-wrapper,
      .comparison-container .converted-wrapper {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
      }
      .comparison-container img {
        display: block;
        width: 100%;
        height: auto;
        user-drag: none;
        user-select: none;
      }
      .slider {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
        width: 5px;
        background-color: #fff;
        cursor: ew-resize;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      .slider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 40px;
        height: 40px;
        background-color: #000;
        border-radius: 50%;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        transform: translate(-50%, -50%);
        z-index: 11;
      }
      .slider::after {
        content: "\2194";
        font-size: 18px;
        color: #fff;
        position: absolute;
        z-index: 12;
      }
      .toggle-button {
        background-color: #1c1c1c;
        color: #fff;
        border: 1px solid red;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        padding: 10px;
        transition: left 0.3s, background-color 0.3s;
        z-index: 10;
        border-radius: 0 5px 5px 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      button {
        background-color: #8b0000;
        color: #fff;
        border: none;
        border-radius: 20px;
        padding: 15px 20px;
        cursor: pointer;
        margin: 10px;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: red;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Background Removal</h1>
      <nav>
        <a href="index.html">Home</a>
        <div class="dropdown">
          <a href="#">Audio Tools</a>
          <div class="dropdown-content">
            <a href="audio-converter.html">Audio Converter</a>
          </div>
        </div>
        <div class="dropdown">
          <a href="#">Video Tools</a>
          <div class="dropdown-content">
            <a href="video-converter.html">Video Converter</a>
          </div>
        </div>
        <div class="dropdown">
          <a href="#">Image Tools</a>
          <div class="dropdown-content">
            <a href="image-extraction.html">PDF Image Extraction</a>
            <a href="background-removal.html">Background Removal</a>
            <a href="image-converter.html">Image Converter</a>
          </div>
        </div>
        <div class="dropdown">
          <a href="#">Web Tools</a>
          <div class="dropdown-content">
            <a href="html-validator.html">HTML/CSS Validator</a>
            <a href="json-formatter.html">JSON Formatter</a>
            <a href="regex-tester.html">Regex Tester</a>
            <a href="json-xml-converter.html">JSON-XML Converter</a>
            <a href="code-beautifier.html">Code Beautifier</a>
            <a href="markdown-previewer.html">Markdown Previewer</a>
            <a href="css-minifier.html">CSS Minifier</a>
          </div>
        </div>
        <div class="dropdown">
          <a href="#">Other Tools</a>
          <div class="dropdown-content">
            <a href="password-generator.html">Password Generator</a>
            <a href="finance-tracker.html">Finance Tracker</a>
            <a href="llm.html">Web-Based LLM</a>
          </div>
        </div>
      </nav>
    </header>
    <div class="container">
      <button id="toggle-sidebar" class="toggle-button">
        <div class="tooltip tooltip-right">
          <svg viewBox="0 0 100 80" width="30" height="30">
            <rect width="100" height="20"></rect>
            <rect y="30" width="100" height="20"></rect>
            <rect y="60" width="100" height="20"></rect>
          </svg>
          <span class="tooltiptext">Click to collapse the sidebar</span>
        </div>
      </button>
      <div class="sidebar">
        <div class="form-group tooltip">
          <label for="source">Image Source:</label>
          <select id="source">
            <option value="image_file">File Upload</option>
            <option value="image_url">Image URL</option>
            <option value="image_file_b64">Base64 String</option>
          </select>
          <span class="tooltiptext">Choose the image source method.</span>
        </div>
        <input
          type="file"
          id="image-upload"
          accept=".jpg, .jpeg, .png"
          style="display: block"
        />
        <div class="form-group tooltip" id="url-group" style="display: none">
          <label for="image-url">Image URL:</label>
          <input type="text" id="image-url" placeholder="Enter Image URL" />
          <span class="tooltiptext">Enter the URL of the image.</span>
        </div>
        <div class="form-group tooltip" id="b64-group" style="display: none">
          <label for="image-b64">Image Base64:</label>
          <textarea id="image-b64" placeholder="Enter Base64 String"></textarea>
          <span class="tooltiptext"
            >Enter the base64-encoded string of the image.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="size">Resolution:</label>
          <select id="size">
            <option value="auto">Auto</option>
            <option value="preview">Preview</option>
            <option value="full">Full</option>
            <option value="50MP">50MP</option>
            <option value="medium">Medium</option>
            <option value="hd">HD</option>
          </select>
          <span class="tooltiptext">Select the desired image resolution.</span>
        </div>
        <div class="form-group tooltip">
          <label for="type">Foreground Type:</label>
          <select id="type">
            <option value="auto">Auto</option>
            <option value="person">Person</option>
            <option value="product">Product</option>
            <option value="animal">Animal</option>
            <option value="car">Car</option>
            <option value="graphic">Graphic</option>
            <option value="transportation">Transportation</option>
          </select>
          <span class="tooltiptext"
            >Specify the type of foreground to detect.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="type-level">Type Level:</label>
          <select id="type-level">
            <option value="none">None</option>
            <option value="1">1 (Coarse)</option>
            <option value="2">2 (Detailed)</option>
            <option value="latest">Latest</option>
          </select>
          <span class="tooltiptext"
            >Set the classification level for the foreground.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="format">Image Format:</label>
          <select id="format">
            <option value="auto">Auto</option>
            <option value="png">PNG</option>
            <option value="jpg">JPG</option>
            <option value="zip">ZIP</option>
          </select>
          <span class="tooltiptext"
            >Choose the output format for the image.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="roi">Region of Interest:</label>
          <input type="text" id="roi" placeholder="e.g., 0% 0% 100% 100%" />
          <span class="tooltiptext"
            >Define the region of interest (ROI) in the image.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="crop">Crop Image:</label>
          <input type="checkbox" id="crop" />
          <span class="tooltiptext">Enable cropping of the image.</span>
        </div>
        <div
          class="form-group tooltip"
          id="crop-margin-group"
          style="display: none"
        >
          <label for="crop-margin">Crop Margin:</label>
          <input type="text" id="crop-margin" placeholder="e.g., 30px, 10%" />
          <span class="tooltiptext"
            >Set the margin around the cropped subject.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="scale">Scale:</label>
          <select id="scale">
            <option value="original">Original</option>
            <option value="fit">Fit</option>
            <option value="fill">Fill</option>
          </select>
          <span class="tooltiptext"
            >Adjust the scale of the image subject.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="position">Position:</label>
          <input type="text" id="position" placeholder="e.g., 50% 50%" />
          <span class="tooltiptext"
            >Set the position of the subject within the image.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="channels">Channels:</label>
          <select id="channels">
            <option value="rgba">RGBA</option>
            <option value="alpha">Alpha</option>
          </select>
          <span class="tooltiptext">Select the image channels to process.</span>
        </div>
        <div class="form-group tooltip">
          <label for="shadow-type">Shadow Type:</label>
          <select id="shadow-type">
            <option value="none">None</option>
            <option value="auto">Auto</option>
            <option value="car">Car</option>
            <option value="3D">3D</option>
            <option value="drop">Drop</option>
          </select>
          <span class="tooltiptext"
            >Choose the type of shadow for the subject.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="shadow-opacity">Shadow Opacity:</label>
          <input
            type="number"
            id="shadow-opacity"
            min="0"
            max="100"
            placeholder="0-100"
          />
          <span class="tooltiptext">Set the opacity of the shadow.</span>
        </div>
        <div class="form-group tooltip">
          <label for="semitransparency">Semi-transparency:</label>
          <input type="checkbox" id="semitransparency" />
          <span class="tooltiptext"
            >Enable semi-transparent regions in the image.</span
          >
        </div>
        <div class="form-group tooltip">
          <label for="bg-color">Background Color:</label>
          <input type="color" id="bg-color" title="Choose a color" />
          <input
            type="text"
            id="bg-color-hex"
            readonly
            style="width: 100px; margin-left: 10px; text-align: center"
          />
          <div
            id="color-preview"
            style="
              width: 30px;
              height: 30px;
              border: 1px solid #000;
              display: inline-block;
              vertical-align: middle;
              margin-left: 10px;
            "
          ></div>
          <span class="tooltiptext">Set a solid color background.</span>
        </div>
        <div class="form-group tooltip">
          <label for="bg-image-url">Background Image URL:</label>
          <input type="text" id="bg-image-url" placeholder="Enter URL" />
          <span class="tooltiptext"
            >Provide a URL for the background image.</span
          >
        </div>
        <button class="remove-bg-btn" onclick="removeBackground()">
          Remove Background
        </button>
      </div>
      <div class="main-content">
        <h2>Remove Background from Image</h2>
        <p class="description">
          Use this tool to remove the background from any image seamlessly.
          Upload your image, choose the desired settings, and watch as the
          background is automatically removed. Use the slider to compare the
          original image with the processed one for a clear before-and-after
          view.
        </p>
        <div id="message"></div>
        <p class="warning">
          Note: This tool relies on an external API for background removal,
          which has 50 uses monthly. If you encounter issues, try again later.
        </p>
        <div
          class="comparison-container"
          id="comparison-container"
          style="display: none"
        >
          <div class="image-wrapper">
            <img id="original-image" alt="Original Image" />
          </div>
          <div class="converted-wrapper">
            <img id="converted-image" alt="Converted Image" />
          </div>
          <div class="slider" id="slider"></div>
        </div>
        <button
          id="download-button"
          style="display: none"
          onclick="downloadImage()"
        >
          Download Image
        </button>
      </div>
    </div>
    <footer>
      <p>&copy; 2024 Jarrod's Website. All rights reserved.</p>
    </footer>
    <script>
      const apiKeys = [
        "VLiX2psPycMn2dVRfTbUZoip",
        "bWFnyvvguRTCyQ4RDu8kAamd",
        "B7C9AaygMJpwrMskPHucAZra",
      ];
      let downloadUrl;

      document.getElementById("source").addEventListener("change", function () {
        const selectedSource = this.value;
        document.getElementById("image-upload").style.display =
          selectedSource === "image_file" ? "block" : "none";
        document.getElementById("url-group").style.display =
          selectedSource === "image_url" ? "block" : "none";
        document.getElementById("b64-group").style.display =
          selectedSource === "image_file_b64" ? "block" : "none";
      });

      document.getElementById("crop").addEventListener("change", function () {
        document.getElementById("crop-margin-group").style.display = this
          .checked
          ? "block"
          : "none";
      });

      document.addEventListener("DOMContentLoaded", () => {
        const sidebar = document.querySelector(".sidebar");
        const toggleButton = document.getElementById("toggle-sidebar");
        const tooltipDiv = toggleButton.querySelector(".tooltip");
        const tooltipText = toggleButton.querySelector(".tooltiptext");
        const sidebarContents = sidebar.querySelectorAll(
          ".form-group, .remove-bg-btn, #image-upload"
        );
        const imageSource = document.getElementById("source");
        const urlGroup = document.getElementById("url-group");
        const b64Group = document.getElementById("b64-group");
        const fileInput = document.getElementById("image-upload");
        const cropCheckbox = document.getElementById("crop");
        const cropMarginGroup = document.getElementById("crop-margin-group");

        let selectedSource = imageSource.value; // Track selected input type
        let isCropChecked = cropCheckbox.checked; // Track crop checkbox state

        // Function to center the button vertically
        function centerToggleButton() {
          const windowHeight = window.innerHeight;
          const buttonHeight = toggleButton.offsetHeight;
          toggleButton.style.top = `${(windowHeight - buttonHeight) / 2 - 83}px`;
        }

        // Function to hide sidebar contents immediately
        function hideSidebarContents() {
          sidebarContents.forEach((el) => {
            el.classList.remove("visible"); // Remove visibility for fade-in
            el.classList.remove("fade-in"); // Remove fade-in class
            el.style.display = "none"; // Hide immediately
          });
        }

        // Function to show sidebar contents with fade-in effect
        function showSidebarContents() {
          sidebarContents.forEach((el) => {
            if (
              (el === urlGroup && selectedSource === "image_url") ||
              (el === b64Group && selectedSource === "image_file_b64") ||
              (el !== urlGroup && el !== b64Group)
            ) {
              el.style.display = "block"; // Make visible relevant elements
              el.classList.add("fade-in");
              setTimeout(() => el.classList.add("visible"), 10); // Apply fade-in after setting display
            }
          });
          cropMarginGroup.style.display = isCropChecked ? "block" : "none"; // Show or hide crop margin
        }

        // Center the button on load and when resized
        centerToggleButton();
        window.addEventListener("resize", centerToggleButton);

        toggleButton.addEventListener("click", () => {
          sidebar.classList.toggle("collapsed");

          if (sidebar.classList.contains("collapsed")) {
            toggleButton.style.left = "-10px"; // Position when collapsed
            tooltipText.textContent = "Click to expand the sidebar";
            tooltipDiv.classList.add("right"); // Add class to move tooltip to the right
            selectedSource = imageSource.value; // Save the current selected source
            isCropChecked = cropCheckbox.checked; // Save the crop checkbox state
            hideSidebarContents(); // Hide sidebar contents
          } else {
            toggleButton.style.left = "281px"; // Position when expanded
            tooltipText.textContent = "Click to collapse the sidebar";
            tooltipDiv.classList.remove("right"); // Remove class to reset tooltip position
            setTimeout(showSidebarContents, 300); // Show contents after sidebar transition
          }

          // Center the button after toggling
          centerToggleButton();
        });

        // Handle changes in the source select element
        imageSource.addEventListener("change", () => {
          selectedSource = imageSource.value; // Update the selected source
          fileInput.style.display =
            selectedSource === "image_file" ? "block" : "none";
          urlGroup.style.display =
            selectedSource === "image_url" ? "block" : "none";
          b64Group.style.display =
            selectedSource === "image_file_b64" ? "block" : "none";
        });

        // Handle changes in the crop checkbox
        cropCheckbox.addEventListener("change", () => {
          isCropChecked = cropCheckbox.checked; // Update the crop checkbox state
          cropMarginGroup.style.display = isCropChecked ? "block" : "none"; // Show or hide crop margin
        });
      });

      document
        .getElementById("bg-color")
        .addEventListener("input", function () {
          const colorValue = this.value;
          document.getElementById("color-preview").style.backgroundColor =
            colorValue;
          document.getElementById("bg-color-hex").value = colorValue; // Update hex value
        });

      async function removeBackground() {
        const fileInput = document.getElementById("image-upload");
        const imageUrlInput = document.getElementById("image-url");
        const imageB64Input = document.getElementById("image-b64");
        const comparisonContainer = document.getElementById(
          "comparison-container"
        );
        const originalImage = document.getElementById("original-image");
        const convertedImage = document.getElementById("converted-image");
        const downloadButton = document.getElementById("download-button");
        const message = document.getElementById("message");
        const source = document.getElementById("source").value;
        const size = document.getElementById("size").value;
        const type = document.getElementById("type").value;
        const typeLevel = document.getElementById("type-level").value;
        const format = document.getElementById("format").value;
        const roi = document.getElementById("roi").value;
        const crop = document.getElementById("crop").checked ? "true" : "false";
        const cropMargin = document.getElementById("crop-margin").value;
        const scale = document.getElementById("scale").value;
        const position = document.getElementById("position").value;
        const channels = document.getElementById("channels").value;
        const shadowType = document.getElementById("shadow-type").value;
        const shadowOpacity = document.getElementById("shadow-opacity").value;
        const semitransparency = document.getElementById("semitransparency")
          .checked
          ? "true"
          : "false";
        const bgColor = document.getElementById("bg-color").value;
        const bgImageUrl = document.getElementById("bg-image-url").value;

        message.textContent = "";
        downloadButton.style.display = "none";
        comparisonContainer.style.display = "none";

        let formData = new FormData();

        if (source === "image_file" && fileInput.files.length > 0) {
          formData.append("image_file", fileInput.files[0]);
        } else if (source === "image_url") {
          formData.append("image_url", imageUrlInput.value);
        } else if (source === "image_file_b64") {
          formData.append("image_file_b64", imageB64Input.value);
        } else {
          message.textContent = "Please provide a valid image source.";
          message.style.color = "yellow";
          message.style.fontWeight = "bold";
          return;
        }

        formData.append("size", size);
        formData.append("type", type);
        formData.append("type_level", typeLevel);
        formData.append("format", format);
        formData.append("roi", roi);
        formData.append("crop", crop);
        formData.append("crop_margin", cropMargin);
        formData.append("scale", scale);
        formData.append("position", position);
        formData.append("channels", channels);
        formData.append("shadow_type", shadowType);
        formData.append("shadow_opacity", shadowOpacity);
        formData.append("semitransparency", semitransparency);
        formData.append("bg_color", bgColor);
        formData.append("bg_image_url", bgImageUrl);

        console.log(...formData.entries());

        message.textContent = "Removing background...";

        for (const key of apiKeys) {
          try {
            const response = await fetch(
              "https://api.remove.bg/v1.0/removebg",
              {
                method: "POST",
                headers: { "X-Api-Key": key },
                body: formData,
              }
            );

            if (response.ok) {
              const blob = await response.blob();
              const downloadUrl = URL.createObjectURL(blob);

              originalImage.onload = () => {
                comparisonContainer.style.width = originalImage.width + "px";
                comparisonContainer.style.height = originalImage.height + "px";
                convertedImage.style.width = originalImage.width + "px";
                convertedImage.style.height = originalImage.height + "px";

                comparisonContainer.style.display = "block";
                downloadButton.style.display = "block";
                message.textContent = "Background removed successfully!";
                initComparisons();
              };

              originalImage.src = URL.createObjectURL(fileInput.files[0]);
              convertedImage.src = downloadUrl;
              return;
            } else if (response.status === 400) {
              message.textContent =
                "Error: Invalid parameters or input file unprocessable.";
              break;
            } else if (response.status === 402) {
              message.textContent = `API key ${key} limit exceeded, trying next key...`;
            } else if (response.status === 403) {
              message.textContent =
                "Error: Authentication failed. Please check your API key.";
              break;
            } else if (response.status === 429) {
              message.textContent =
                "Error: Rate limit exceeded. Please try again later.";
              break;
            } else {
              const errorText = await response.text();
              throw new Error(errorText);
            }
          } catch (error) {
            console.error(`Error with API key ${key}:`, error);
            message.textContent = `Error: ${error.message}`;
          }
        }

        message.textContent =
          "An unexpected error occurred or all API keys are exhausted.";
      }

      function downloadImage() {
        const link = document.createElement("a");
        link.href = downloadUrl;
        link.download = "background-removed.png";
        link.click();
      }

      function initComparisons() {
        const slider = document.getElementById("slider");
        const comparisonContainer = document.getElementById(
          "comparison-container"
        );
        const convertedWrapper = document.querySelector(".converted-wrapper");
        const imageWrapper = document.querySelector(".image-wrapper");
        let clicked = false;

        slider.style.left = comparisonContainer.offsetWidth / 2 + "px";
        convertedWrapper.style.clip = `rect(0, ${
          comparisonContainer.offsetWidth / 2
        }px, ${comparisonContainer.offsetHeight}px, 0)`;
        imageWrapper.style.clip = `rect(0, ${
          comparisonContainer.offsetWidth
        }px, ${comparisonContainer.offsetHeight}px, ${
          comparisonContainer.offsetWidth / 2
        }px)`;

        slider.addEventListener("mousedown", () => {
          clicked = true;
          window.addEventListener("mousemove", slideMove);
          window.addEventListener("mouseup", slideStop);
        });

        function slideMove(event) {
          if (!clicked) return;
          slide(getCursorPos(event));
          window.getSelection().removeAllRanges();
        }

        function slideStop() {
          clicked = false;
          window.removeEventListener("mousemove", slideMove);
          window.removeEventListener("mouseup", slideStop);
        }

        function getCursorPos(event) {
          const rect = comparisonContainer.getBoundingClientRect();
          return event.clientX - rect.left;
        }

        function slide(x) {
          const containerWidth = comparisonContainer.offsetWidth;
          x = Math.max(0, Math.min(x, containerWidth));

          slider.style.left = x + "px";
          convertedWrapper.style.clip = `rect(0, ${x}px, ${comparisonContainer.offsetHeight}px, 0)`;
          imageWrapper.style.clip = `rect(0, ${containerWidth}px, ${comparisonContainer.offsetHeight}px, ${x}px)`;
        }
      }
    </script>
  </body>
</html>
